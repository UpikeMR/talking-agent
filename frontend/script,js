const recordBtn = document.getElementById('recordBtn');
const playBtn = document.getElementById('playBtn');
const status = document.getElementById('status');
let mediaRecorder;
let audioChunks = [];

recordBtn.addEventListener('click', async () => {
    if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/wav' });
            audioChunks = [];

            mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
            mediaRecorder.onstop = sendAudio;

            mediaRecorder.start();
            recordBtn.textContent = 'Stop Recording';
            recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            recordBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            status.textContent = 'Recording...';
        } catch (err) {
            status.textContent = 'Error: Microphone access denied';
            console.error(err);
        }
    } else {
        mediaRecorder.stop();
        recordBtn.textContent = 'Speak Now';
        recordBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
        recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
        status.textContent = 'Processing...';
    }
});

async function sendAudio() {
    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
    const formData = new FormData();
    formData.append('audio', audioBlob, 'input.wav');

    try {
        const response = await fetch('https://talking-agent-backend.onrender.com/conversation', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) throw new Error('Server error');

        const audioResponse = await response.blob();
        const audioUrl = URL.createObjectURL(audioResponse);
        const audio = new Audio(audioUrl);
        
        audio.onplay = () => status.textContent = 'Playing response...';
        audio.onended = () => status.textContent = 'Press "Speak Now" to start';
        audio.play();

        playBtn.classList.remove('hidden');
    } catch (err) {
        status.textContent = 'Error: Failed to get response';
        console.error(err);
    }
}